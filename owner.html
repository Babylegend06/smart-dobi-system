<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - DOBIABU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-color: #4e73df; --bg-color: #f8f9fc; }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', sans-serif; }
        .sidebar { min-height: 100vh; background: linear-gradient(180deg, #4e73df 10%, #224abe 100%); color: white; }
        .nav-link { color: rgba(255,255,255,0.8); margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); border-radius: 5px; }
        .card { border: none; border-radius: 10px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #2e59d9); color: white; }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); color: white; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-none d-md-block sidebar p-3">
            <h4 class="text-center mb-4"><i class="fas fa-soap"></i> DOBIABU Admin</h4>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-history me-2"></i> Laporan</a></li>
                <li class="nav-item"><a class="nav-link" href="kiosk.html" target="_blank"><i class="fas fa-store me-2"></i> Buka Kiosk</a></li>
                <li class="nav-item mt-4"><a class="nav-link text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Log Keluar</a></li>
            </ul>
        </nav>

        <main class="col-md-10 ms-sm-auto px-md-4 py-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Papan Pemuka Utama</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <span id="connectionStatus" class="badge bg-secondary">Menyambung ke Firebase...</span>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-start border-primary border-4 h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Pendapatan Hari Ini</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="todayRevenue">RM 0.00</div>
                                </div>
                                <div class="col-auto"><i class="fas fa-dollar-sign fa-2x text-gray-300"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-start border-success border-4 h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Mesin Aktif</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="activeMachines">0 / 2</div>
                                </div>
                                <div class="col-auto"><i class="fas fa-industry fa-2x text-gray-300"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-5 mb-4">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 bg-white">
                            <h6 class="m-0 font-weight-bold text-primary">Status Mesin Live</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded" id="machine1-card">
                                <div>
                                    <h6 class="mb-0">Mesin Basuh 1 (7kg)</h6>
                                    <small class="text-muted" id="m1-user">-</small>
                                </div>
                                <span class="badge bg-success" id="m1-status">Available</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-2 border rounded" id="machine2-card">
                                <div>
                                    <h6 class="mb-0">Mesin Basuh 2 (10kg)</h6>
                                    <small class="text-muted" id="m2-user">-</small>
                                </div>
                                <span class="badge bg-success" id="m2-status">Available</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-7 mb-4">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 bg-white">
                            <h6 class="m-0 font-weight-bold text-primary">Trend Pendapatan (7 Hari)</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white">
                    <h6 class="m-0 font-weight-bold text-primary">Transaksi Terkini</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Masa</th>
                                    <th>Mesin</th>
                                    <th>Pelanggan (WhatsApp)</th>
                                    <th>Jumlah</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="txnTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // ðŸ”´ GANTIKAN CONFIG ANDA DI SINI
    const firebaseConfig = {
        apiKey: "API_KEY_ANDA",
        authDomain: "smart-dobi-system-fyp.firebaseapp.com",
        databaseURL: "https://smart-dobi-system-fyp-default-rtdb.firebaseio.com",
        projectId: "smart-dobi-system-fyp",
        storageBucket: "smart-dobi-system-fyp.appspot.com",
        messagingSenderId: "SENDER_ID",
        appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 1. Monitor System Heartbeat (ESP32 Online Check)
    const connectedRef = ref(db, ".info/connected");
    onValue(connectedRef, (snap) => {
        const el = document.getElementById('connectionStatus');
        if (snap.val() === true) {
            el.innerHTML = "Dashboard: ONLINE";
            el.className = "badge bg-success";
        } else {
            el.innerHTML = "Dashboard: OFFLINE";
            el.className = "badge bg-danger";
        }
    });

    // 2. Monitor Machine Status Realtime
    const machinesRef = ref(db, 'machines');
    onValue(machinesRef, (snapshot) => {
        const data = snapshot.val();
        updateMachineUI(1, data['1']);
        updateMachineUI(2, data['2']); // Asumsi struktur mesin 2 ada
        
        // Update total active machines
        let active = 0;
        if(data['1']?.status === 'running') active++;
        if(data['2']?.status === 'running') active++;
        document.getElementById('activeMachines').innerText = `${active} / 2`;
    });

    function updateMachineUI(id, data) {
        if(!data) return;
        const statusEl = document.getElementById(`m${id}-status`);
        const userEl = document.getElementById(`m${id}-user`);
        const cardEl = document.getElementById(`machine${id}-card`);
        
        userEl.innerText = data.whatsapp || "Tiada Pengguna";

        if (data.status === 'running') {
            statusEl.className = "badge bg-danger";
            statusEl.innerText = "Sedang Digunakan";
            cardEl.style.borderLeft = "5px solid #e74a3b";
        } else if (data.status === 'ready') {
            statusEl.className = "badge bg-warning text-dark";
            statusEl.innerText = "Sedia (Tunggu Button)";
            cardEl.style.borderLeft = "5px solid #f6c23e";
        } else {
            statusEl.className = "badge bg-success";
            statusEl.innerText = "Available";
            cardEl.style.borderLeft = "5px solid #1cc88a";
        }
    }

    // 3. Setup Chart.js (Dummy Data Logic for Demo)
    const ctx = document.getElementById('revenueChart').getContext('2d');
    const revChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu', 'Ahad'],
            datasets: [{
                label: 'Pendapatan (RM)',
                data: [12, 19, 3, 5, 22, 35, 15], // Nanti sambung ke Firebase 'daily_records'
                borderColor: '#4e73df',
                tension: 0.3,
                fill: true,
                backgroundColor: 'rgba(78, 115, 223, 0.05)'
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });

    // Logout Function
    window.logout = function() {
        alert("Log keluar berjaya!");
        window.location.href = "index.html";
    }
</script>
</body>
</html>
