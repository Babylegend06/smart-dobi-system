<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOBIABU - Pembayaran</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Fredoka One', cursive;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .header { width:100%; text-align:center; margin-bottom:30px; padding:20px 0; }
        .logo { font-size:3.5rem; font-weight:bold; letter-spacing:2px; text-shadow:3px 3px 0 rgba(0,0,0,0.2); margin-bottom:10px; }
        .subtitle { font-size:1.2rem; opacity:0.9; }
        .payment-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius:20px;
            border:1px solid rgba(255,255,255,0.2);
            padding:30px;
            width:90%;
            max-width:500px;
            text-align:center;
            box-shadow:0 10px 30px rgba(0,0,0,0.2);
            margin-bottom:30px;
        }
        .qr-code { width:200px; height:200px; margin:20px auto; background:white; padding:15px; border-radius:10px; }
        .status-label {
            font-size:1.2rem; margin:20px 0; padding:10px 20px;
            border-radius:50px; display:inline-block;
            background:rgba(244,67,54,0.3); color:#ef9a9a;
        }
        .status-paid { background:rgba(76,175,80,0.3); color:#a5d6a7; }
        .whatsapp-section {
            margin:25px 0; padding:20px;
            background:rgba(255,255,255,0.1); border-radius:15px; text-align:left;
        }
        .whatsapp-title { font-size:1.3rem; margin-bottom:15px; text-align:center; }
        .whatsapp-input {
            width:100%; padding:12px 15px; margin:10px 0;
            border-radius:10px; border:1px solid rgba(255,255,255,0.3);
            background:rgba(255,255,255,0.1); color:white;
            font-size:1rem;
            font-family:'Fredoka One', cursive;
        }
        .button {
            display:inline-block; padding:15px 30px; margin:10px;
            background:rgba(255,255,255,0.2); color:white;
            text-decoration:none;
            border-radius:50px; border:1px solid rgba(255,255,255,0.3);
            font-family:'Fredoka One', cursive;
            font-size:1.2rem; cursor:pointer;
        }
        .button:hover { background:rgba(255,255,255,0.3); transform:scale(1.05); }
        .footer { margin-top:20px; text-align:center; font-size:0.9rem; opacity:0.7; }
        #error-msg {
          color: #ff9e9e;
          margin-top: 10px;
          font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">DOBIABU</div>
        <div class="subtitle">PEMBAYARAN</div>
    </div>
    
    <div class="payment-container">
        <h2>Imbas QR & Bayar</h2>
        <div class="qr-code">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=170x170&data=DOBIABU_DEMO" style="width:100%">
        </div>
        <p>Status: <span id="status-label" class="status-label">BELUM DIBAYAR</span></p>
        
        <div class="whatsapp-section">
            <div class="whatsapp-title">NOTIFIKASI WHATSAPP (Optional)</div>
            <input type="text" id="whatsapp-number" class="whatsapp-input" placeholder="0189892155">
        </div>
        
        <button onclick="bayar()" class="button">BAYAR</button>
        <div id="error-msg"></div>
    </div>
    
    <div class="footer">Sistem Dobi Moden &copy; 2026</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBPaObgmHZBQR8-0aX3pTUOFeMOxIsn0Lc",
            authDomain: "smart-dobi-system-fyp.firebaseapp.com",
            databaseURL: "https://smart-dobi-system-fyp-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smart-dobi-system-fyp",
            storageBucket: "smart-dobi-system-fyp.firebasestorage.app",
            messagingSenderId: "377544234994",
            appId: "1:377544234994:web:690cd32c142e7ee501fd6b"
        };

        let db;
        try {
          const app = initializeApp(firebaseConfig);
          db = getDatabase(app);
        } catch (e) {
          document.getElementById('error-msg').innerText = 'Ralat sistem. Cuba lagi nanti.';
          return;
        }

        const url = new URL(window.location.href);
        const machine = url.searchParams.get("machine") || "1";
        if (!["1", "2"].includes(machine)) {
          alert("Mesin tidak sah.");
          window.location.href = "index.html";
        }

        function bayar() {
            const waInput = document.getElementById('whatsapp-number').value.trim();
            const cleanWa = waInput.replace(/\D/g, '');
            
            if (cleanWa && !/^\d{9,12}$/.test(cleanWa)) {
                document.getElementById('error-msg').innerText = "Nombor WhatsApp tidak sah!";
                return;
            }

            update(ref(db, `machines/${machine}`), {
                status: "ready",
                whatsapp: cleanWa || null
            }).then(() => {
                document.getElementById("status-label").innerText = "SUDAH DIBAYAR";
                document.getElementById("status-label").className = "status-label status-paid";
                setTimeout(() => {
                    window.location.href = `page3.html?machine=${machine}`;
                }, 1500);
            }).catch(err => {
                console.error(err);
                document.getElementById('error-msg').innerText = "Gagal hantar ke sistem. Cuba lagi.";
            });
        }
    </script>
</body>
</html>
