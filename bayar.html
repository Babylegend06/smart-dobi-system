<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dobi Mijan - Pembayaran</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .glass-container {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            width: 100%;
            max-width: 500px;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
            font-weight: 600;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1rem;
        }

        .machine-info {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .machine-info div {
            color: white;
            margin: 5px 0;
        }

        .qr-container {
            display: flex;
            justify-content: center;
            margin: 25px 0;
        }

        .qr-placeholder {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .qr-lines {
            width: 100%;
            margin-bottom: 15px;
        }

        .qr-line {
            height: 4px;
            background: #333;
            margin: 8px 0;
            border-radius: 2px;
        }

        .qr-placeholder p {
            color: #666;
            font-size: 0.9rem;
            text-align: center;
        }

        .whatsapp-preview {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #25D366;
        }

        .whatsapp-preview h4 {
            color: white;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .whatsapp-preview p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: white;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-group input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.25);
        }

        .phone-format-hint {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: center;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .action-buttons button {
            flex: 1;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-confirm {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-confirm:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-confirm:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            opacity: 0.6;
        }

        @media (max-width: 480px) {
            .glass-container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.7rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="glass-container">
        <h1>Bayar & Cuci</h1>
        <p class="subtitle">Selesaikan pembayaran untuk Mesin <span id="selected-machine">1</span></p>
        
        <div class="machine-info">
            <div><strong>ESP32 Controller:</strong> <span id="esp-controller">1</span></div>
            <div><strong>Relay Port:</strong> <span id="relay-port">A</span></div>
            <div><strong>Status:</strong> <span id="machine-status">Available</span></div>
        </div>
        
        <div class="qr-container">
            <div class="qr-placeholder">
                <div class="qr-lines">
                    <div class="qr-line"></div>
                    <div class="qr-line"></div>
                    <div class="qr-line"></div>
                    <div class="qr-line"></div>
                </div>
                <p>QR Code Pembayaran</p>
            </div>
        </div>
        
        <div class="whatsapp-preview">
            <h4>ðŸ“± Notifikasi WhatsApp Akan Dihantar</h4>
            <p>Setelah pembayaran, anda akan menerima:</p>
            <p>â€¢ âœ… Konfirmasi pembayaran & lampu ON</p>
            <p>â€¢ ðŸš€ Notifikasi bila mesin start</p>
            <p>â€¢ ðŸŽ‰ Notifikasi bila cucian selesai</p>
        </div>
        
        <div class="form-group">
            <label for="phone">Nombor Telefon WhatsApp:</label>
            <input type="tel" id="phone" placeholder="Contoh: 0123456789" required>
            <div class="phone-format-hint">Format: 0123456789 (tanpa +60)</div>
        </div>
        
        <div class="action-buttons">
            <button class="btn-back" onclick="goBack()">Kembali</button>
            <button class="btn-confirm" onclick="confirmPayment()">Confirm Bayar</button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBPaObgmHZBQR8-0aX3pTUOFeMOxIsn0Lc",
            authDomain: "smart-dobi-system-fyp.firebaseapp.com",
            databaseURL: "https://smart-dobi-system-fyp-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smart-dobi-system-fyp",
            storageBucket: "smart-dobi-system-fyp.firebasestorage.app",
            messagingSenderId: "377544234994",
            appId: "1:377544234994:web:690cd32c142e7ee501fd6b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const selectedMachine = parseInt(localStorage.getItem('selectedMachine')) || 1;
        
        // Determine ESP32 controller and relay port
        let espController, relayPort;
        if (selectedMachine <= 2) {
            espController = 1;
            relayPort = selectedMachine === 1 ? 'A' : 'B';
        } else {
            espController = 2;
            relayPort = selectedMachine === 3 ? 'A' : 'B';
        }

        document.getElementById('selected-machine').textContent = selectedMachine;
        document.getElementById('esp-controller').textContent = espController;
        document.getElementById('relay-port').textContent = relayPort;

        function goBack() {
            window.location.href = 'index.html';
        }

        async function confirmPayment() {
            const phone = document.getElementById('phone').value;
            
            // Validate phone number
            if (!phone || phone.length < 10) {
                alert('Sila masukkan nombor telefon yang sah');
                return;
            }
            
            const phoneRegex = /^(01)[0-46-9]*[0-9]{7,8}$/;
            if (!phoneRegex.test(phone.replace(/[-\s]/g, ''))) {
                alert('Sila masukkan nombor telefon Malaysia yang sah (contoh: 0123456789)');
                return;
            }
            
            try {
                const confirmBtn = document.querySelector('.btn-confirm');
                confirmBtn.textContent = 'Memproses...';
                confirmBtn.disabled = true;
                
                // Write to Firebase
                await writeToFirebase(selectedMachine, phone, espController, relayPort);
                
                localStorage.setItem('customerPhone', phone);
                window.location.href = 'timer.html';
                
            } catch (error) {
                console.error('Payment error:', error);
                alert('Ralat pembayaran. Sila cuba lagi.');
                
                const confirmBtn = document.querySelector('.btn-confirm');
                confirmBtn.textContent = 'Confirm Bayar';
                confirmBtn.disabled = false;
            }
        }

        function writeToFirebase(machineId, phone, espController, relayPort) {
            return new Promise((resolve, reject) => {
                const timestamp = Date.now();
                
                // Write payment data
                const paymentRef = database.ref('payments/' + machineId + '_' + timestamp);
                paymentRef.set({
                    machineId: machineId,
                    phone: phone,
                    status: 'PAID',
                    timestamp: timestamp,
                    espController: espController,
                    relayPort: relayPort
                }, (error) => {
                    if (error) {
                        reject(error);
                    } else {
                        // Update machine status to READY
                        const machineRef = database.ref('machines/' + machineId);
                        machineRef.update({
                            status: 'READY',
                            currentUser: phone,
                            lastUpdated: timestamp,
                            espController: espController,
                            relayPort: relayPort
                        }, (error) => {
                            if (error) {
                                reject(error);
                            } else {
                                resolve();
                            }
                        });
                    }
                });
            });
        }

        // Phone number input formatting
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.startsWith('01')) {
                if (value.length <= 3) {
                    value = value;
                } else if (value.length <= 6) {
                    value = value.replace(/(\d{3})(\d{0,3})/, '$1 $2');
                } else if (value.length <= 9) {
                    value = value.replace(/(\d{3})(\d{3})(\d{0,4})/, '$1 $2 $3');
                } else {
                    value = value.replace(/(\d{3})(\d{3})(\d{0,4})/, '$1 $2 $3');
                }
            }
            
            e.target.value = value;
        });
    </script>
</body>
</html>
